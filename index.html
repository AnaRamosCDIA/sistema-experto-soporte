<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistema Experto de Soporte IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; }
        .diagnosis-card { transition: all 0.3s ease-in-out; }
        .step-indicator { transition: all 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-900">

<div id="app" class="min-h-screen p-4 sm:p-8 flex items-center justify-center"></div>

<script>
const API_BASE_URL = 'http://127.0.0.1:8000';

// Estado global
let state = {
    step: 1, // 1 = selección, 2 = diagnóstico, "report" = form reporte
    symptoms: {
        app_lenta_o_congela: false,
        app_cierra_inesperadamente: false,
        instalacion_o_actualizacion_fallida: false,
        pantalla_azul_o_negra_reciente: false,
        periferico_no_detectado: false,
    },
    diagnosis: null,
    sessionId: null,
    isLoading: false,
    error: null,
};

const symptomList = [
    { key: 'app_lenta_o_congela', label: 'Aplicación Lenta o Congelada', icon: 'Monitor' },
    { key: 'app_cierra_inesperadamente', label: 'Aplicación se Cierra Sola', icon: 'X' },
    { key: 'instalacion_o_actualizacion_fallida', label: 'Instalación / Update Fallido', icon: 'Zap' },
    { key: 'pantalla_azul_o_negra_reciente', label: 'Pantalla Azul o Bloqueo Reciente (BSOD)', icon: 'Bug' },
    { key: 'periferico_no_detectado', label: 'Periférico (USB/Cámara) No Detectado', icon: 'Usb' }
];

const DIAGNOSTICO_ICONS = {
    RESTAURAR_SISTEMA_O_DRIVERS_CRITICOS: 'Power',
    CONFLICTO_DE_SOFTWARE_O_LIBRERIAS: 'Cpu',
    REINTENTAR_COMO_ADMINISTRADOR: 'Zap',
    REINSTALAR_APLICACION_LIMPIANDO_CACHE: 'CheckCircle',
    FINALIZAR_TAREA_Y_REINICIAR_APP: 'Power',
    ACTUALIZAR_DRIVER_O_PUERTO: 'Usb',
    REINICIAR_SISTEMA_SIMPLE: 'Power',
};

// --- Render principal ---
function render() {
    const app = document.getElementById('app');
    if (!app) return;

    let contentHTML = '';

    const headerHTML = `
        <header class="mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-teal-400 flex items-center">
                ${getIconSvg('Cpu', 32, 'mr-3')}
                Sistema Experto de Soporte IA
            </h1>
            <p class="text-gray-400 mt-1">Diagnóstico inteligente para problemas de software y drivers.</p>
        </header>
        <div class="flex justify-between items-center mb-10">
            ${renderStepIndicator(1, state.step, "1. Identificar Problema")}
            <div class="flex-grow h-0.5 bg-gray-700 mx-2 sm:mx-4"></div>
            ${renderStepIndicator(2, state.step, "2. Solución y Feedback")}
        </div>
        ${state.error ? renderError(state.error) : ''}
    `;

    // Paso 1: selección de síntomas
    if (state.step === 1) {
        const isNextDisabled = Object.values(state.symptoms).every(v => v === false);
        contentHTML = `
            <h2 class="text-2xl font-semibold mb-6 text-gray-200">¿Qué está sucediendo con tu sistema?</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${symptomList.map(renderSymptomCard).join('')}
            </div>

            <div class="flex justify-between mt-8">
                <button id="reportButton" type="button"
                    class="flex items-center bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-3 rounded-lg font-bold shadow-md">
                    ${getIconSvg('Plus', 18, 'mr-2')} Reportar otro problema
                </button>

                <button id="diagnoseButton"
                        ${isNextDisabled || state.isLoading ? 'disabled' : ''}
                        class="flex items-center px-8 py-3 rounded-full font-bold transition-all duration-300 ${
                            isNextDisabled || state.isLoading
                                ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                                : 'bg-teal-600 hover:bg-teal-500 text-white'
                        }">
                    ${state.isLoading ? `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>` : 'Diagnosticar Problema'}
                    ${!state.isLoading ? getIconSvg('ArrowRight', 20, 'ml-2') : ''}
                </button>
            </div>
        `;
    }

    // Paso 2: diagnóstico y feedback
    else if (state.step === 2 && state.diagnosis) {
        contentHTML = `
            ${renderDiagnosisCard(state.diagnosis)}
            <h3 class="text-xl font-semibold mt-8 mb-4 border-b border-gray-700 pb-2 text-gray-200">Pasos de Solución Detallados</h3>
            <ol class="space-y-3 list-decimal list-inside text-gray-300">
                ${state.diagnosis.detalles_recomendaciones.map((rec, index) => `
                    <li class="pl-2 flex items-start">
                        <span class="font-medium text-teal-400 mr-2">${index + 1}.</span>
                        ${rec}
                    </li>
                `).join('')}
            </ol>

            <div class="mt-12 pt-6 border-t border-gray-700">
                <h3 class="text-xl font-semibold mb-4 text-center text-teal-400">¿Esta Solución Resolvió el Problema?</h3>
                <div class="flex justify-center space-x-6">
                    ${renderFeedbackButton('SÍ, Éxito', 'EXITOSO', 'green', 'CheckCircle')}
                    ${renderFeedbackButton('NO, Falló', 'FALLIDO', 'red', 'XCircle')}
                </div>
                <button id="resetButton" class="mt-6 mx-auto block text-gray-400 hover:text-teal-400 transition-colors">
                    ${getIconSvg('ArrowLeft', 16, 'inline mr-1')} Iniciar un Nuevo Diagnóstico
                </button>
            </div>
        `;
    }

    // Paso "report": formulario para reportar problema
    else if (state.step === "report") {
        contentHTML = `
            <h2 class="text-2xl font-semibold mb-6 text-gray-200">Desarrolle su Problema</h2>
            <textarea id="userReport" rows="7"
                class="w-full p-4 rounded-xl bg-gray-700 text-white placeholder-gray-400 focus:outline-teal-500"
                placeholder="Escriba aquí los detalles de su problema..."></textarea>
            <div class="flex justify-end mt-6 space-x-4">
                <button id="saveReportButton"
                    class="px-6 py-3 bg-teal-600 hover:bg-teal-500 rounded-lg font-bold text-white shadow-lg flex items-center">
                    ${getIconSvg('Save', 20, 'mr-2')} Guardar reporte y generar ticket
                </button>
                <button id="cancelReportButton"
                    class="px-6 py-3 bg-gray-600 hover:bg-gray-500 rounded-lg font-bold text-white shadow-lg">
                    Cancelar
                </button>
            </div>
        `;
    }

    // Inyectar
    app.innerHTML = `
        <div class="w-full max-w-4xl bg-gray-800/80 backdrop-blur-md rounded-2xl shadow-2xl p-6 sm:p-10 text-white">
            ${headerHTML}
            ${contentHTML}
        </div>
    `;

    // Asignar eventos después de inyectar HTML
    attachEvents();
    // Crear iconos
    lucide.createIcons();
}

// --- Auxiliares de render ---
function getIconSvg(name, size = 24, classes = '') {
    return `<span class="${classes}" data-lucide="${name}" width="${size}" height="${size}"></span>`;
}

function renderSymptomCard(symptom) {
    const isSelected = state.symptoms[symptom.key];
    const base = "flex flex-col items-center p-6 border-2 rounded-xl transition-all duration-300 cursor-pointer h-32";
    const active = "bg-teal-700 border-teal-500 shadow-xl text-white transform scale-[1.02]";
    const inactive = "bg-gray-700 border-gray-600 hover:bg-gray-600/70 text-gray-300";
    return `
        <div data-key="${symptom.key}" class="symptom-card ${base} ${isSelected ? active : inactive}">
            ${getIconSvg(symptom.icon, 32, 'mb-2')}
            <span class="text-sm text-center font-medium">${symptom.label}</span>
        </div>
    `;
}

function renderStepIndicator(step, currentStep, label) {
    const isActive = step === currentStep;
    const isCompleted = step < currentStep;
    let circleClasses = "w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold";
    if (isCompleted) circleClasses += " bg-teal-500 text-gray-900";
    else if (isActive) circleClasses += " bg-teal-700 text-white ring-2 ring-teal-500";
    else circleClasses += " bg-gray-600 text-gray-400";
    return `
        <div class="flex items-center step-indicator">
            <div class="${circleClasses}">${isCompleted ? '✓' : step}</div>
            <span class="ml-3 text-sm font-semibold ${isActive ? 'text-white' : 'text-gray-500'}">${label}</span>
        </div>
    `;
}

function renderDiagnosisCard(diagnosis) {
    const IconName = DIAGNOSTICO_ICONS[diagnosis.diagnostico_principal] || 'CheckCircle';
    return `
        <div class="p-6 border rounded-xl shadow-lg diagnosis-card border-teal-600 bg-teal-900/20 text-teal-300 mb-6">
            <div class="flex items-center space-x-4">
                ${getIconSvg(IconName, 40, 'flex-shrink-0')}
                <div>
                    <h2 class="text-2xl font-bold text-white">Diagnóstico Principal:</h2>
                    <p class="text-3xl font-extrabold text-white mt-1">${diagnosis.diagnostico_principal.replace(/_/g, ' ')}</p>
                </div>
            </div>
        </div>
    `;
}

function renderFeedbackButton(label, result, color, icon) {
    const base = `flex items-center px-6 py-3 rounded-lg font-bold text-white shadow-md`;
    const dynamic = color === 'green' ? 'bg-green-600 hover:bg-green-500' : 'bg-red-600 hover:bg-red-500';
    return `<button data-result="${result}" class="feedback-button ${base} ${dynamic}">${getIconSvg(icon, 20, 'mr-2')}${label}</button>`;
}

function renderError(message) {
    return `
        <div class="mb-4 p-4 bg-red-800/50 border border-red-700 text-red-300 rounded-lg flex items-center">
            ${getIconSvg('AlertTriangle', 20, 'mr-3')}
            <span class="font-semibold">${message}</span>
        </div>
    `;
}

// --- Manejo de eventos ---
function attachEvents() {
    // síntomas: toggle
    document.querySelectorAll('.symptom-card').forEach(card => {
        card.onclick = () => {
            const key = card.getAttribute('data-key');
            // Sólo toggle si es una key existente en state.symptoms
            if (Object.prototype.hasOwnProperty.call(state.symptoms, key)) {
                state.symptoms[key] = !state.symptoms[key];
                render();
            }
        };
    });

    // botón diagnosticar
    const diagnoseBtn = document.getElementById('diagnoseButton');
    if (diagnoseBtn) diagnoseBtn.onclick = sendDiagnosis;

    // botón report (abre form)
    const reportBtn = document.getElementById('reportButton');
    if (reportBtn) {
        reportBtn.onclick = (e) => {
            e.preventDefault();
            state.step = "report";
            render();
        };
    }

    // botón guardar reporte
    const saveReportBtn = document.getElementById('saveReportButton');
    if (saveReportBtn) saveReportBtn.onclick = sendReport;

    // cancelar reporte
    const cancelReportBtn = document.getElementById('cancelReportButton');
    if (cancelReportBtn) cancelReportBtn.onclick = () => {
        state.step = 1;
        render();
    };

    // feedback buttons
    document.querySelectorAll('.feedback-button').forEach(btn => {
        btn.onclick = (e) => sendFeedback(e.currentTarget.getAttribute('data-result'));
    });

    // reset
    const resetBtn = document.getElementById('resetButton');
    if (resetBtn) resetBtn.onclick = resetSystem;

    // asegurar íconos
    lucide.createIcons();
}

// --- API calls ---
async function sendDiagnosis() {
    if (Object.values(state.symptoms).every(v => v === false)) return;
    state.isLoading = true;
    state.error = null;
    render();
    try {
        const res = await fetch(`${API_BASE_URL}/diagnosticar`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(state.symptoms)
        });
        if (!res.ok) throw new Error('Error en /diagnosticar');
        const data = await res.json();
        state.diagnosis = data;
        state.sessionId = data.sesion_id || data.sesion_id || null;
        state.step = 2;
    } catch (err) {
        console.error('Error diagnosticar:', err);
        state.error = "Error al comunicarse con el motor de diagnóstico.";
    }
    state.isLoading = false;
    render();
}

async function sendReport() {
    const textarea = document.getElementById('userReport');
    if (!textarea) return;
    const reportText = textarea.value.trim();
    if (!reportText) return alert("Por favor, escriba algo antes de guardar.");
    try {
        const res = await fetch(`${API_BASE_URL}/reportar_problema`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ descripcion: reportText })
        });
        if (!res.ok) throw new Error('Error al guardar reporte en servidor');
        const data = await res.json();
        alert("✅ Reporte guardado correctamente");
        console.log("Respuesta del servidor:", data);
        state.step = 1;
        render();
    } catch (err) {
        console.error("Error enviarReport:", err);
        alert("❌ No se pudo enviar el reporte al servidor.");
    }
}

async function sendFeedback(result) {
    if (!state.sessionId) return;
    try {
        const res = await fetch(`${API_BASE_URL}/feedback/${state.sessionId}?resultado=${result}`, {
            method: 'POST'
        });
        if (!res.ok) throw new Error('Error al enviar feedback');
        // opcional: manejar respuesta
        resetSystem();
    } catch (err) {
        console.error('Error feedback:', err);
        state.error = "Error al enviar feedback.";
        render();
    }
}

function resetSystem() {
    state = {
        step: 1,
        symptoms: {
            app_lenta_o_congela: false,
            app_cierra_inesperadamente: false,
            instalacion_o_actualizacion_fallida: false,
            pantalla_azul_o_negra_reciente: false,
            periferico_no_detectado: false,
        },
        diagnosis: null,
        sessionId: null,
        isLoading: false,
        error: null,
    };
    render();
}

window.onload = render;
</script>
</body>
</html>
